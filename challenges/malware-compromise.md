# Network Analysis - Malware Compromise

## Scenario:

A SOC Analyst at Umbrella Corporation is going through SIEM alerts and sees the alert for connections to a known malicious domain. The traffic is coming from Sara’s computer, an Accountant who receives a large volume of emails from customers daily. Looking at the email gateway logs for Sara’s mailbox there is nothing immediately suspicious, with emails coming from customers. Sara is contacted via her phone and she states a customer sent her an invoice that had a document with a macro, she opened the email and the program crashed. The SOC Team retrieved a PCAP for further analysis.

## Configure Wireshark:

First, it is important to set the timezone to UTC format to avoid any confusion during the analysis. To do that, in Wireshark, I clicked `View` => `Time display format` and selected `UTC Date and time of day`.

Second, I added two more columns: **Source port** and **Destination port**.

## Analysis:

To prioritize the investigation, I checked the protocols in action in the packet capture by clicking on `Statistics` => `Protocol hierarchy`. This provides a high-level overview of all the communications.

![](../assets/packets-in-use.png)

The next thing to note are the IPs involved in the conversation. Clicking on `Statistics` => `Conversations` => `IPv4` shows the conversations that the IP `10.11.27.101` had with different IPs. This is crucial for identifying which external host potentially infected the machine.

![](../assets/conversations.png)

Since DNS queries are often the first step in a malware infection chain, I started analyzing the packets. The first thing I saw was a DNS query and a DNS response involving the domain `klychenoggcom`. Analyzing the domain on [Virustotal](https://www.virustotal.com/) showed that 9 out of 97 security vendors flagged the URL as malicious.

![klychenogg.com](../assets/klychenoggcom.png)

Now, focusing on the first HTTP GET request, I saw this URL: `QIC/tewokl.php?l=spet10.spr`. Following the HTTP stream, one of the lines in the response contained the string `This program cannot be run in DOS mode.`, which is a sign of a portable executable like a `.exe` or `.dll`. I made a note of this.

Next, I investigated HTTP requests involving the suspicious IP `95.181.198.231`. I did this by right-clicking the HTTP protocol, selecting `Prepare as a Filter` => `Selected`, and then right-clicking the IP address, selecting `Prepare as a filter` => `...and Selected`. This prepared the filter `(_ws.col.protocol == "HTTP") && (ip.dst == 95.181.198.231)`.

This showed two results. The first one was the previously selected request, and the second one at `16:38:39` involved a `.rar` file:

```sh
911	2018-11-27 16:38:39.383458	10.11.27.101	49181	95.181.198.231	80	HTTP	236	GET /oiioiashdqbwe.rar HTTP/1.1 
```

I concluded that the private IP of the infected host is `10.11.27.101` and the full URL from where Ursnif retrieves the follow-up malware is `http://95.181.198.231/oiioiashdqbwe.rar`.

Continuing a methodical investigation of the IP addresses the infected host communicated with, I moved to another IP listed in the conversation: `176.32.33.108`. I applied the filter `ip.addr == 176.32.33.108` to check for source or destination traffic associated with the IP.

![176.32.33.108 traffic](../assets/1763233108traffic.png)

Analyzing the traffic, I saw the three-way handshake (`SYN`, `SYN ACK`, and `ACK`) in the first three packets, and the fourth one was a GET request to an `/images` directory. Following the HTTP stream, I saw the domain `cochrimato.com`. Checking it on Virustotal showed that 4 out of 94 vendors flagged this domain as malicious.

![cochrimato.com](../assets/cochrimatocom.png)

`cochrimato.com` is the domain from which the HTTP requests with `GET /images/` were coming.

Checking the response, I found some code that looked like **Base64**, but after checking it online, it did not show anything interesting.

Malware often uses encrypted connections to hide its C2 communication from network monitoring tools. While I cannot see the content of the encrypted data without a decryption key, I can still extract metadata. By inspecting the Client Hello packets, specifically the Server Name Indication (SNI) field, I could determine the domain the client was trying to connect to.
So, I started by checking the traffic of another IP involved in the conversation, `83.166.247.211`. To do that, I applied the filter `ip.addr==83.166.247.211`.

![TLS traffic](../assets/tls-traffic.png)

The logs showed a lot of `TLS` (Transport Layer Security) traffic, which indicates that this traffic is [encrypted](https://www.cloudflare.com/learning/ssl/transport-layer-security-tls/).

I looked at the SNI field by examining the client `hello packet`. This tells me what domain the internal IP address is trying to access. I filtered for `Client Hello Packets` by selecting packet **757**, which contains a `Client Hello` and an SNI field with the domain `SNI=mautergase.com`.

![mautergase.com](../assets/mautergasecom.png)

Accessing the packet details and expanding `Transport Layer Security` => `Handshake protocol`, I found the `Handshake type: client Hello (1)`.

![Client Hello handshake](../assets/client-hello-handshake.png)

Right-clicking it and selecting `Prepare as a filter` => `Selected` resulted in the filter `tls.handshake.type == 1`, which showed all Client Hello traffic along with all the SNI fields, all of which showed `SNI=mautergase.com`. Checking the domain on VirusTotal did not show any interesting results, nor did the IP. Filtering the results by DNS (as I saw in the protocol hierarchy) also did not show any interesting results.

To continue the investigation, corroborate my findings, and get another perspective, I opened the `.pcap` file in [Zui](https://www.brimdata.io/download/). Zui can provide a higher-level, event-based view of the traffic.

Clicking in the **Query pool**, I started querying the `.pcap` by typing `alert` and hitting Enter. This was the result:

![Zui alert query](../assets/zui-alert-query.png)

To show only the alerts, I expanded the first `alert` result, right-clicked, and selected `Filter == Value`. The query now looked like this: `alert | event_type=="alert"`, which listed 12 rows of alerts.

![Zui alerts](../assets/zui-alerts.png)

Examining these alert logs, I found many of them with strings related to malware, so I could affirm that this user was infected with malware.

![Malware alert](../assets/malware-alert.png)

In this capture, I also saw that `185.244.150.230` is the Dridex post-infection traffic IP.

Finally, I returned to Wireshark to perform a deeper static analysis. I downloaded the files by clicking on the menu `File` => `Export objects` => `HTTP` and saved all the malware in a **malware** folder.

Opening a terminal in the **malware** folder, I ran `file *` and found some interesting details about the files:

![Malware details](../assets/malware-details.png)

Generating a hash for the files by running `sha256sum + filename` and checking the hashes on **Virustotal**, I found that `tewokl.php%3fl=spet10.spr` was flagged as malicious by many security vendors:

![tewokl.php%3fl=spet10.spr flagged as malicious](../assets/flagged-as-malicious.png)

I concluded that the malware binary `spet10.spr` is the one that the macro document was trying to retrieve. This final step allowed me to confirm that the downloaded files were indeed malicious payloads.

## Conclusion:

I concluded that Sara's computer was compromised by malware. The initial infection was triggered by a macro in an email attachment, which led to a series of malicious network activities, including DNS queries to known bad domains, the download of additional malware binaries, and the establishment of encrypted command-and-control communication with multiple external IP addresses.
